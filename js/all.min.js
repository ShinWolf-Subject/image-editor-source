class ImageEditor{constructor(){this.canvas=null;this.currentTool='select';this.currentColor='#000000';this.brushSize=5;this.history=[];this.historyIndex=-1;this.init()}init(){this.setupCanvas();this.setupTheme();this.setupUI();this.setupTools();this.setupEvents();this.saveState()}setupCanvas(){this.canvas=new fabric.Canvas('canvas',{width:800,height:600,backgroundColor:'#ffffff'});this.resizeCanvas();window.addEventListener('resize',()=>this.resizeCanvas())}resizeCanvas(){const container=document.querySelector('.canvas-container');const rect=container.getBoundingClientRect();const maxWidth=rect.width-32;const maxHeight=rect.height-32;const scale=Math.min(maxWidth/800,maxHeight/600,1);this.canvas.setZoom(scale);this.canvas.renderAll()}setupTheme(){const toggle=document.getElementById('themeToggle');const theme=localStorage.getItem('theme')||'light';this.setTheme(theme);toggle.addEventListener('click',()=>{const current=document.body.getAttribute('data-theme')||'light';const newTheme=current==='light'?'dark':'light';this.setTheme(newTheme)})}setTheme(theme){document.body.setAttribute('data-theme',theme);document.getElementById('themeToggle').innerHTML=theme==='light'?'<i class="fas fa-moon"></i>':'<i class="fas fa-sun"></i>';localStorage.setItem('theme',theme)}setupUI(){const sidebar=document.getElementById('sidebar');const properties=document.getElementById('properties');const overlay=document.getElementById('overlay');document.getElementById('sidebarToggle').addEventListener('click',()=>{sidebar.classList.toggle('open');if(sidebar.classList.contains('open')){overlay.classList.add('show');properties.classList.remove('open')}else{overlay.classList.remove('show')}});document.getElementById('propsToggle').addEventListener('click',()=>{properties.classList.toggle('open');if(properties.classList.contains('open')){overlay.classList.add('show');sidebar.classList.remove('open')}else{overlay.classList.remove('show')}});overlay.addEventListener('click',()=>{sidebar.classList.remove('open');properties.classList.remove('open');overlay.classList.remove('show')});window.addEventListener('resize',()=>{if(window.innerWidth>=1280){sidebar.classList.remove('open');properties.classList.remove('open');overlay.classList.remove('show')}})}setupTools(){const tools={selectTool:()=>this.setTool('select'),drawTool:()=>this.setTool('draw'),textTool:()=>this.setTool('text'),eraseTool:()=>this.setTool('erase')};Object.entries(tools).forEach(([id,handler])=>{document.getElementById(id).addEventListener('click',handler)});const shapes={rectTool:()=>this.addShape('rect'),circleTool:()=>this.addShape('circle'),triangleTool:()=>this.addShape('triangle'),lineTool:()=>this.addShape('line')};Object.entries(shapes).forEach(([id,handler])=>{document.getElementById(id).addEventListener('click',handler)});document.querySelectorAll('.color-btn').forEach(btn=>{btn.addEventListener('click',()=>this.setColor(btn.dataset.color))});document.getElementById('customColor').addEventListener('input',(e)=>{this.setColor(e.target.value)});const brushSize=document.getElementById('brushSize');brushSize.addEventListener('input',(e)=>{this.brushSize=parseInt(e.target.value);document.getElementById('brushSizeValue').textContent=e.target.value+'px';if(this.canvas.freeDrawingBrush){this.canvas.freeDrawingBrush.width=this.brushSize}})}setupEvents(){document.getElementById('imageUpload').addEventListener('change',(e)=>{this.loadImage(e.target.files[0])});document.getElementById('exportBtn').addEventListener('click',()=>{this.exportImage()});document.getElementById('undoBtn').addEventListener('click',()=>this.undo());document.getElementById('redoBtn').addEventListener('click',()=>this.redo());document.getElementById('clearBtn').addEventListener('click',()=>{if(confirm('Clear canvas?')){this.canvas.clear();this.canvas.backgroundColor='#ffffff';this.canvas.renderAll();this.saveState()}});this.setupProperties();this.canvas.on('object:modified',()=>this.saveState());this.canvas.on('path:created',()=>this.saveState());this.canvas.on('object:selected',(e)=>this.updateProperties(e.target));document.addEventListener('keydown',(e)=>this.handleKeyboard(e))}setupProperties(){const props={fillColor:(value)=>this.updateObjectProperty('fill',value),strokeColor:(value)=>this.updateObjectProperty('stroke',value),strokeWidth:(value)=>{this.updateObjectProperty('strokeWidth',parseInt(value));document.getElementById('strokeWidthValue').textContent=value+'px'},opacity:(value)=>{this.updateObjectProperty('opacity',parseInt(value)/100);document.getElementById('opacityValue').textContent=value+'%'},fontSize:(value)=>{this.updateObjectProperty('fontSize',parseInt(value));document.getElementById('fontSizeValue').textContent=value+'px'}};Object.entries(props).forEach(([id,handler])=>{document.getElementById(id).addEventListener('input',(e)=>handler(e.target.value))});document.getElementById('toFront').addEventListener('click',()=>{const obj=this.canvas.getActiveObject();if(obj){obj.bringToFront();this.canvas.renderAll();this.saveState()}});document.getElementById('toBack').addEventListener('click',()=>{const obj=this.canvas.getActiveObject();if(obj){obj.sendToBack();this.canvas.renderAll();this.saveState()}});document.getElementById('deleteBtn').addEventListener('click',()=>{const obj=this.canvas.getActiveObject();if(obj){this.canvas.remove(obj);this.saveState()}})}setTool(tool){this.currentTool=tool;document.querySelectorAll('.tool-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById(tool+'Tool').classList.add('active');switch(tool){case'select':this.canvas.isDrawingMode=false;this.canvas.selection=true;break;case'draw':this.canvas.isDrawingMode=true;this.canvas.freeDrawingBrush.width=this.brushSize;this.canvas.freeDrawingBrush.color=this.currentColor;break;case'text':this.canvas.isDrawingMode=false;this.addText();break;case'erase':this.canvas.isDrawingMode=true;this.canvas.freeDrawingBrush=new fabric.EraserBrush(this.canvas);this.canvas.freeDrawingBrush.width=this.brushSize;break}this.closePanels()}setColor(color){this.currentColor=color;document.querySelectorAll('.color-btn').forEach(btn=>btn.classList.remove('active'));document.querySelector(`[data-color="${color}"]`)?.classList.add('active');document.getElementById('customColor').value=color;if(this.canvas.freeDrawingBrush){this.canvas.freeDrawingBrush.color=color}const obj=this.canvas.getActiveObject();if(obj){if(obj.type==='i-text'){obj.set('fill',color)}else{obj.set('stroke',color)}this.canvas.renderAll();this.saveState()}}addText(){const text=new fabric.IText('Double click to edit',{left:100,top:100,fontFamily:'Arial',fontSize:20,fill:this.currentColor});this.canvas.add(text);this.canvas.setActiveObject(text);this.saveState()}addShape(type){let shape;const options={left:100,top:100,fill:'transparent',stroke:this.currentColor,strokeWidth:2};switch(type){case'rect':shape=new fabric.Rect({...options,width:100,height:100});break;case'circle':shape=new fabric.Circle({...options,radius:50});break;case'triangle':shape=new fabric.Triangle({...options,width:100,height:100});break;case'line':shape=new fabric.Line([0,0,100,0],{...options,left:100,top:100});break}if(shape){this.canvas.add(shape);this.canvas.setActiveObject(shape);this.saveState();this.closePanels()}}loadImage(file){if(!file)return;const reader=new FileReader();reader.onload=(e)=>{fabric.Image.fromURL(e.target.result,(img)=>{const scale=Math.min(this.canvas.width/2/img.width,this.canvas.height/2/img.height,1);img.set({left:50,top:50,scaleX:scale,scaleY:scale});this.canvas.add(img);this.canvas.setActiveObject(img);this.saveState();this.closePanels()})};reader.readAsDataURL(file)}exportImage(){const dataURL=this.canvas.toDataURL({format:'png',quality:1});const link=document.createElement('a');link.href=dataURL;link.download=`image-${Date.now()}.png`;document.body.appendChild(link);link.click();document.body.removeChild(link)}updateObjectProperty(property,value){const obj=this.canvas.getActiveObject();if(obj){obj.set(property,value);this.canvas.renderAll();this.saveState()}}updateProperties(obj){if(!obj)return;if(window.innerWidth<1280){document.getElementById('properties').classList.add('open');document.getElementById('overlay').classList.add('show')}if(obj.fill&&obj.fill!=='transparent'){document.getElementById('fillColor').value=this.rgbToHex(obj.fill)}if(obj.stroke){document.getElementById('strokeColor').value=this.rgbToHex(obj.stroke)}document.getElementById('strokeWidth').value=obj.strokeWidth||0;document.getElementById('strokeWidthValue').textContent=(obj.strokeWidth||0)+'px';document.getElementById('opacity').value=Math.round((obj.opacity||1)*100);document.getElementById('opacityValue').textContent=Math.round((obj.opacity||1)*100)+'%';if(obj.type==='i-text'){document.getElementById('fontSize').value=obj.fontSize||20;document.getElementById('fontSizeValue').textContent=(obj.fontSize||20)+'px'}}saveState(){if(this.historyIndex<this.history.length-1){this.history=this.history.slice(0,this.historyIndex+1)}this.history.push(JSON.stringify(this.canvas.toJSON()));this.historyIndex=this.history.length-1;this.updateHistoryButtons()}updateHistoryButtons(){document.getElementById('undoBtn').disabled=this.historyIndex<=0;document.getElementById('redoBtn').disabled=this.historyIndex>=this.history.length-1}undo(){if(this.historyIndex>0){this.historyIndex--;this.canvas.loadFromJSON(this.history[this.historyIndex],()=>{this.canvas.renderAll();this.updateHistoryButtons()})}}redo(){if(this.historyIndex<this.history.length-1){this.historyIndex++;this.canvas.loadFromJSON(this.history[this.historyIndex],()=>{this.canvas.renderAll();this.updateHistoryButtons()})}}closePanels(){if(window.innerWidth<1280){document.getElementById('sidebar').classList.remove('open');document.getElementById('properties').classList.remove('open');document.getElementById('overlay').classList.remove('show')}}handleKeyboard(e){if(e.ctrlKey||e.metaKey){switch(e.key.toLowerCase()){case'z':e.preventDefault();e.shiftKey?this.redo():this.undo();break;case's':e.preventDefault();this.exportImage();break}}if(e.key==='Delete'||e.key==='Backspace'){const obj=this.canvas.getActiveObject();if(obj&&document.activeElement.tagName!=='INPUT'){e.preventDefault();this.canvas.remove(obj);this.saveState()}}if(e.key==='Escape'){this.closePanels()}}rgbToHex(rgb){if(!rgb||rgb.indexOf('rgb')===-1)return rgb||'#000000';const match=rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);if(!match)return'#000000';const hex=(x)=>("0"+parseInt(x).toString(16)).slice(-2);return"#"+hex(match[1])+hex(match[2])+hex(match[3])}}document.addEventListener('DOMContentLoaded',()=>{new ImageEditor()});
